<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team Extreme Blog</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* Dark Gray (gray-900) */
        }
        /* Custom scrollbar for aesthetics on dark theme */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-thumb { background: #60a5fa; /* Blue-400 */ border-radius: 4px; }
        ::-webkit-scrollbar-track { background: #374151; /* Gray-700 */ }

        .post-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .post-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 15px 20px -5px rgba(0, 0, 0, 0.4), 0 6px 6px -3px rgba(0, 0, 0, 0.2);
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Header & Author Controls -->
    <header class="bg-gray-900 shadow-xl sticky top-0 z-10 border-b border-blue-700/50">
        <div class="max-w-4xl mx-auto p-4 flex justify-between items-center">
            <!-- Updated Title -->
            <h1 class="text-3xl font-bold text-gray-100 tracking-tight">
                Team <span class="text-blue-400">Extreme</span>
            </h1>
            
            <!-- Loading Indicator -->
            <div id="loading-indicator" class="text-blue-400 font-medium hidden">Loading posts...</div>

            <!-- Author Controls -->
            <div id="author-controls" class="hidden">
                <button onclick="openModal()" class="bg-blue-600 hover:bg-blue-500 text-white font-semibold py-2 px-4 rounded-lg shadow-lg transition duration-150 ease-in-out">
                    + Add New Post
                </button>
            </div>
            
            <div id="auth-status" class="text-sm text-gray-400 flex flex-col items-end">
                <span id="user-id-display">Authenticating...</span>
            </div>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="flex-grow max-w-4xl mx-auto py-8 px-4">
        
        <!-- Persistent Introduction Panel - UPDATED STYLING -->
        <section class="mb-8 p-8 bg-gray-800 rounded-2xl shadow-2xl border-l-8 border-blue-500 transform transition duration-500 hover:shadow-blue-900/50">
            <!-- Centered Heading: added justify-center and changed background to gray-800 for contrast -->
            <h3 class="text-3xl font-extrabold text-blue-400 mb-3 tracking-wider flex items-center justify-center">
                <span class="mr-3 text-4xl">ðŸŽ¬</span> Welcome to Team Extreme!
            </h3>
            <p class="text-gray-200 leading-relaxed text-lg">
                Welcome to the **ultimate archive for British comedy fanatics**. **Team Extreme** is dedicated to providing **complete and comprehensive guides** to the greatest sitcoms produced between the **1960s and the 1990s**. From the humble beginnings of telly gold to the iconic classics that defined a generation, dive in with us as we revisit every episode, every catchphrase, and every moment of genius. Prepare for a deep dive into the history of UK comedy!
            </p>
        </section>
        
        <h2 class="text-2xl font-semibold text-gray-100 mb-6 border-b border-gray-700 pb-2">Latest Entries</h2>
        
        <!-- Blog Posts Container -->
        <div id="posts-container" class="space-y-6">
            <!-- Posts will be injected here by JavaScript -->
            <p id="no-posts-message" class="text-gray-400 text-center py-10 hidden">
                It looks a little empty here! As the author, you can add the first post.
            </p>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-900 text-gray-400 p-4 mt-auto border-t border-blue-700/50">
        <div class="max-w-4xl mx-auto text-center text-sm">
            &copy; <span id="current-year"></span> Team Extreme. Hosted on Netlify.
        </div>
    </footer>

    <!-- Add New Post Modal (Hidden by default) -->
    <div id="post-modal" class="fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center hidden z-20" onclick="closeModal(event)">
        <div class="bg-gray-800 p-6 rounded-xl shadow-2xl w-full max-w-md m-4 border border-blue-700/50" onclick="event.stopPropagation()">
            <h3 class="text-xl font-bold mb-4 text-gray-100">Create New Post</h3>
            <form id="new-post-form" onsubmit="handlePostSubmit(event)">
                <div class="mb-4">
                    <label for="post-title" class="block text-sm font-medium text-gray-300 mb-1">Title</label>
                    <input type="text" id="post-title" required class="w-full px-3 py-2 border border-gray-600 bg-gray-700 text-white rounded-lg focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="mb-4">
                    <label for="post-content" class="block text-sm font-medium text-gray-300 mb-1">Content</label>
                    <textarea id="post-content" rows="6" required class="w-full px-3 py-2 border border-gray-600 bg-gray-700 text-white rounded-lg focus:ring-blue-500 focus:border-blue-500"></textarea>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="closeModal()" class="px-4 py-2 text-sm font-medium text-gray-200 bg-gray-700 rounded-lg hover:bg-gray-600 transition duration-150">
                        Cancel
                    </button>
                    <button type="submit" id="submit-post-btn" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-500 transition duration-150">
                        Publish Post
                    </button>
                </div>
            </form>
            <p id="error-message" class="text-red-400 text-sm mt-3 hidden"></p>
        </div>
    </div>

    <!-- Firebase Initialization and Logic -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, getDocs, doc, setLogLevel, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Firestore paths
        const PUBLIC_DATA_PATH = `/artifacts/${appId}/public/data`;
        const POSTS_COLLECTION_NAME = 'blog_posts';
        
        let app, db, auth;
        let userId = null;
        let isAuthReady = false;

        setLogLevel('debug'); // Enable detailed Firebase logging

        // --- Utility Functions ---

        /** Formats Firestore Timestamp object into a readable date string. */
        const formatDate = (timestamp) => {
            if (!timestamp) return 'No Date';
            if (timestamp.toDate) {
                return timestamp.toDate().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
            }
            // Fallback for JS Date object or serverTimestamp placeholder
            return new Date(timestamp).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
        };

        /** Renders a single post card element. */
        const renderPost = (post) => {
            const postElement = document.createElement('div');
            // Updated classes for dark theme: bg-gray-800, light text, blue accent border
            postElement.className = 'post-card bg-gray-800 p-6 rounded-xl shadow-xl border border-blue-700/50'; 
            postElement.innerHTML = `
                <h3 class="text-xl font-bold text-gray-50 mb-2">${post.title}</h3>
                <p class="text-sm text-gray-400 mb-4">
                    By <span class="font-medium text-blue-400">${post.author || 'The Host'}</span> on ${formatDate(post.timestamp)}
                </p>
                <div class="text-gray-200 whitespace-pre-wrap">${post.content}</div>
            `;
            return postElement;
        };

        /** Renders all posts to the container. */
        const renderPosts = (posts) => {
            const container = document.getElementById('posts-container');
            const noPostsMessage = document.getElementById('no-posts-message');
            container.innerHTML = ''; // Clear previous posts

            if (posts.length === 0) {
                noPostsMessage.classList.remove('hidden');
                return;
            }
            noPostsMessage.classList.add('hidden');

            // Sort posts by timestamp in descending order (newest first)
            const sortedPosts = posts.sort((a, b) => {
                const timeA = a.timestamp && a.timestamp.toDate ? a.timestamp.toDate().getTime() : 0;
                const timeB = b.timestamp && b.timestamp.toDate ? b.timestamp.toDate().getTime() : 0;
                return timeB - timeA;
            });

            sortedPosts.forEach(post => {
                container.appendChild(renderPost(post));
            });
        };

        // --- Firebase Core Logic ---

        const initFirebase = async () => {
            try {
                if (Object.keys(firebaseConfig).length === 0) {
                     console.error("Firebase config is missing or empty.");
                     return;
                }
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // 1. Perform and AWAIT Initial Sign-In (Guarantees request.auth != null before listener starts)
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken); 
                } else {
                    // If no token, sign in anonymously to ensure permissions for public read access
                    await signInAnonymously(auth);
                }

                // 2. Set user details and update UI status
                const user = auth.currentUser;
                if (user) {
                    userId = user.uid;
                    document.getElementById('user-id-display').textContent = `User ID: ${userId.substring(0, 8)}...`;
                    
                    // Show author controls only if signed in with the special token
                    if (initialAuthToken) {
                        document.getElementById('author-controls').classList.remove('hidden');
                    }
                } else {
                    // Fallback should not happen if sign-in succeeded
                    userId = 'guest';
                    document.getElementById('user-id-display').textContent = `User ID: ${userId.substring(0, 8)}... (Guest)`;
                }

                // 3. Start Real-time Listener only AFTER auth is confirmed and userId is set
                isAuthReady = true;
                startRealtimeListener();

            } catch (error) {
                console.error("Error initializing Firebase or signing in:", error);
                document.getElementById('user-id-display').textContent = 'Error during auth.';
            }
        };
        
        const startRealtimeListener = () => {
            if (!db || !isAuthReady) {
                console.warn("Database or Auth not ready, skipping listener setup.");
                return;
            }

            const postsRef = collection(db, PUBLIC_DATA_PATH, POSTS_COLLECTION_NAME);
            const q = query(postsRef);

            // Use onSnapshot for real-time updates
            const unsubscribe = onSnapshot(q, (snapshot) => {
                document.getElementById('loading-indicator').classList.add('hidden');
                const posts = [];
                snapshot.forEach((doc) => {
                    posts.push({ id: doc.id, ...doc.data() });
                });
                renderPosts(posts);
            }, (error) => {
                console.error("Error fetching real-time posts:", error);
                document.getElementById('loading-indicator').textContent = 'Error loading posts.';
            });

            // Clean up listener when app closes (good practice)
            window.addEventListener('beforeunload', unsubscribe);
        };
        
        /** Handles the submission of a new post to Firestore. */
        window.handlePostSubmit = async (event) => {
            event.preventDefault();
            const titleInput = document.getElementById('post-title');
            const contentInput = document.getElementById('post-content');
            const submitBtn = document.getElementById('submit-post-btn');
            const errorMessage = document.getElementById('error-message');

            const title = titleInput.value.trim();
            const content = contentInput.value.trim();
            const author = userId; // Store the current user's ID as the author identifier

            if (!title || !content || !db) {
                errorMessage.textContent = 'Please fill out all fields.';
                errorMessage.classList.remove('hidden');
                return;
            }

            submitBtn.disabled = true;
            submitBtn.textContent = 'Publishing...';
            errorMessage.classList.add('hidden');

            try {
                const postsRef = collection(db, PUBLIC_DATA_PATH, POSTS_COLLECTION_NAME);
                
                await addDoc(postsRef, {
                    title: title,
                    content: content,
                    author: author,
                    timestamp: serverTimestamp()
                });

                // Clear form and close modal on success
                titleInput.value = '';
                contentInput.value = '';
                closeModal();

            } catch (error) {
                console.error("Error adding document:", error);
                errorMessage.textContent = `Failed to publish post: ${error.message}`;
                errorMessage.classList.remove('hidden');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Publish Post';
            }
        };

        // --- Modal Control Functions ---

        window.openModal = () => {
            document.getElementById('post-modal').classList.remove('hidden');
            document.body.style.overflow = 'hidden'; // Prevent scrolling when modal is open
        };

        window.closeModal = (event) => {
            // Only close if click is on the modal background, or if manually called
            if (!event || event.target.id === 'post-modal') {
                document.getElementById('post-modal').classList.add('hidden');
                document.getElementById('error-message').classList.add('hidden');
                document.body.style.overflow = '';
            }
        };

        // --- Initial Setup ---
        window.onload = () => {
            document.getElementById('current-year').textContent = new Date().getFullYear();
            document.getElementById('loading-indicator').classList.remove('hidden');
            initFirebase();
        };

    </script>
</body>
</html>
